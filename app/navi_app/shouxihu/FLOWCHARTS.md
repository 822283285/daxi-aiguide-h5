# 大希地图核心业务流程图

**生成日期**: 2026-03-01

---

## 1. 应用启动流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        应用启动流程                              │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │ index.html   │
    └──────┬───────┘
           │ 加载
           ▼
    ┌──────────────────┐
    │ bootstrap-loader │ 加载所有依赖资源
    └──────┬───────────┘
           │
           ├─► preload (getParam.js, runtime-config.js)
           ├─► vendor (Zepto, Handlebars, Swiper, Three.js...)
           ├─► map_sdk (DaxiMap SDK 15 个文件)
           └─► daxi_runtime (业务代码)
           │
           ▼
    ┌──────────────┐
    │  app-init.js │ 创建初始化器
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │  DxApp.init  │ 创建应用实例
    └──────┬───────┘
           │
           ├─► 创建 MapView (地图容器)
           ├─► 初始化地图 SDK
           ├─► 创建 LocationManager
           ├─► 添加地图控件
           └─► 注册页面状态
           │
           ▼
    ┌──────────────┐
    │  处理命令    │ processCommand(params)
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 首屏就绪事件 │ dispatchEvent('daxi:first-screen-ready')
    └──────────────┘
```

---

## 2. 命令处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        命令处理流程                              │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  用户操作    │ 点击/搜索/语音/WebSocket 消息
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │  CommandBus  │ 命令总线
    └──────┬───────┘
           │ dispatch(command)
           ▼
    ┌──────────────┐
    │ Middlewares  │ 中间件处理 (可选)
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │  Handlers    │ 处理器
    └──────┬───────┘
           │
           ▼
    ┌─────────────────────┐
    │ pageCommand.runCmd  │ 分发到对应页面
    └──────┬──────────────┘
           │
           ├─► method: showPoi      ──► MapStatePoi
           ├─► method: showRoute    ──► MapStateRoute
           ├─► method: startNavi    ──► MapStateNavi
           ├─► method: openSearch   ──► MapStateSearchPage
           └─► method: ...          ──► ...
           │
           ▼
    ┌──────────────┐
    │ StateManager │ 状态管理器
    └──────┬───────┘
           │
           ├─► pushState()  压入新状态
           ├─► goBack()     返回上一状态
           └─► invokeCallback() 触发回调
```

---

## 3. 地图初始化流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        地图初始化流程                            │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────────────────────────────────┐
    │  MapView(app, container, options)                        │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  1. 创建地图容器                                          │
    │     <div id="Container1" class="map_container"></div>    │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  2. 配置地图参数                                          │
    │     mapConfig = {                                         │
    │       token, appName, baseMapPath, dataPath,             │
    │       buildingId, zoom, lon, lat, ...                    │
    │     }                                                     │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  3. 创建地图 SDK 实例                                      │
    │     mapSDK = new daximap.Map("Container1", mapConfig)    │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  4. 创建位置管理器                                        │
    │     locationManager = new daximap.LocationManager(opts)  │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  5. 监听地图加载完成                                      │
    │     mapSDK.on("loadComplete", callback)                  │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  6. 创建地图控件                                          │
    │     - FloorControl (楼层选择)                             │
    │     - CompassControl (指北针)                             │
    │     - IconButtonControl (爆炸图)                          │
    │     - ComponentsWrapper (组件容器)                        │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  7. 创建导航管理器                                        │
    │     naviManager = mapSDK.getNaviManager()                │
    └──────────────────────────────────────────────────────────┘
                                │
                                ▼
    ┌──────────────────────────────────────────────────────────┐
    │  8. 注册地图事件                                          │
    │     - poiClick, mapClick, floorChanged, ...              │
    └──────────────────────────────────────────────────────────┘
```

---

## 4. POI 数据加载流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        POI 数据加载流程                           │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────┐
                    │  触发 POI 加载  │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  静态 JSON   │ │  API 服务    │ │  地图 SDK    │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           │ GET           │ GET           │ mapSDK
           │ exhibit-all   │ getPoiInfo    │ getPoiById
           │ explain-all   │ search        │ searchPoi
           │               │               │
           ▼               ▼               ▼
    ┌─────────────────────────────────────────────────┐
    │              数据格式化                          │
    │  { poiId, name, lon, lat, bdid, floorId, ... }  │
    └─────────────────────────────────────────────────┘
                           │
                           ▼
    ┌─────────────────────────────────────────────────┐
    │              缓存管理                            │
    │  Cache.set(key, data) / Cache.get(key)          │
    └─────────────────────────────────────────────────┘
                           │
                           ▼
    ┌─────────────────────────────────────────────────┐
    │              UI 渲染                             │
    │  - DXPoiResultView (列表)                        │
    │  - DXPoiDetialView (详情)                        │
    │  - Marker (地图标记)                             │
    └─────────────────────────────────────────────────┘
```

---

## 5. 路线规划流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        路线规划流程                              │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  用户操作    │ 点击"路线"按钮
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ MapStateRoute│ 进入路线规划页面
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  1. 设置起点终点                                         │
    │     startPoint = { lon, lat, bdid, floorId, name }      │
    │     endPoint = { lon, lat, bdid, floorId, name }        │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  2. 选择路线策略                                         │
    │     indoor: fastest / shortest                           │
    │     outdoor: walking / driving / transit                 │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  3. 调用路线规划 API                                      │
    │     mapSDK.calculateRoute({                              │
    │       startPoint, endPoint, strategy, transittype        │
    │     })                                                    │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  4. 接收路线结果                                         │
    │     { distance, duration, steps: [...], path: [...] }    │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  5. 渲染路线 UI                                           │
    │     - DXDriverRouteDetailView (驾车)                     │
    │     - DXBusRouteDetailView (公交)                        │
    │     - DXWalkRouteDetailView (步行)                       │
    │     - 地图高亮显示路径                                    │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐
    │  开始导航    │ 点击"开始导航"
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ MapStateNavi │ 进入导航页面
    └──────────────┘
```

---

## 6. 导航流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        导航流程                                  │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  开始导航    │ naviManager.startNavi(route)
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  1. 初始化导航                                           │
    │     - 加载导航路径                                        │
    │     - 计算当前位置                                        │
    │     - 设置导航参数                                        │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  2. 监听位置更新                                         │
    │     locationManager.on("locationUpdate", callback)       │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  3. 计算导航状态                                         │
    │     - 距离下一个转向点的距离                              │
    │     - 预计到达时间                                        │
    │     - 是否偏离路线                                        │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  4. 触发导航事件                                         │
    │     naviManager.on("routeProgress", data)                │
    │     - 更新 UI (距离、时间)                                │
    │     - 语音播报 ("前方 100 米左转")                          │
    │     - 地图跟随                                            │
    └──────────────────────────────────────────────────────────┘
           │
           ├─► 继续导航 ─────────────┐
           │                        │
           ▼                        │
    ┌──────────────┐                │
    │  到达目的地  │                │
    └──────┬───────┘                │
           │                        │
           ▼                        │
    ┌───────────────────────────────┘
    │  5. 导航结束
    │     - 显示结束信息
    │     - naviManager.exitNavi()
    │     - 返回上一页面
    └───────────────────────────────┘

    导航中操作:
    - pauseNavi()    暂停导航
    - resumeNavi()   恢复导航
    - exitNavi()     退出导航
```

---

## 7. 搜索流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        搜索流程                                  │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  用户输入    │ 文本输入 / 语音输入
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │MapStateSearch│ 搜索页面
    └──────┬───────┘
           │
           ├─► 文本输入 ──► onSearchInputed(text)
           │                │
           │                ▼
           │         ┌──────────────┐
           │         │  searchPoi   │ 调用搜索 API
           │         └──────┬───────┘
           │                │
           │                ▼
           │         ┌──────────────┐
           │         │ 显示搜索结果 │ DXSelectPoiListComponent
           │         └──────┬───────┘
           │                │
           │                ▼
           │         ┌──────────────┐
           │         │ 点击结果项   │
           │         └──────┬───────┘
           │
           ├─► 语音输入 ──► onSearchViewMicBtnClicked()
           │                │
           │                ├─► 原生语音识别 (cordova)
           │                │   │
           │                │   ▼
           │                │ 识别结果回调
           │                │
           │                └─► VoiceListenerPage (H5)
           │                    │
           │                    ▼
           │              识别结果回调
           │
           ├─► 点击历史记录 ──► onListItemClicked(e)
           │
           └─► 点击热搜 ──────► onListItemClicked(e)
                                │
                                ▼
                         ┌──────────────┐
                         │  回调返回    │ invokeCallback("searchPageCallback")
                         └──────┬───────┘
                                │
                                ▼
                         ┌──────────────┐
                         │ MapStatePoi  │ 显示 POI
                         └──────────────┘
```

---

## 8. 状态管理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        状态管理流程                              │
└─────────────────────────────────────────────────────────────────┘

                         ┌──────────────┐
                         │ StateManager │
                         └──────┬───────┘
                                │
         ┌──────────────────────┼──────────────────────┐
         │                      │                      │
         ▼                      ▼                      ▼
  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
  │  状态注册   │       │  状态跳转   │       │  状态事件   │
  └──────┬──────┘       └──────┬──────┘       └──────┬──────┘
         │                     │                     │
         │ registState()       │ pushState()         │ _on()
         │                     │ goBack()            │ _emit()
         │                     │ getCurrentState()   │ _once()
         │                     │                     │
         ▼                     ▼                     ▼
  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐
  │ 状态实例存储 │       │  状态栈管理 │       │ 事件总线    │
  │ MapState X  │       │ [S1, S2, S3]│       │ EventEmitter│
  └─────────────┘       └─────────────┘       └─────────────┘

状态生命周期:
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│ initialize() │ ──► │   show()     │ ──► │   hide()     │ ──► │  dispose()   │
│  初始化      │     │   显示       │     │   隐藏       │     │   销毁       │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
       ▲                    ▲                    ▲                    ▲
       │                    │                    │                    │
       └────────────────────┴────────────────────┴────────────────────┘
                            状态流转

状态示例:
HomePage ──► MapStateBrowse ──► MapStatePoi ──► MapStatePoiDetail
     │                              │
     │                              └─► MapStateRoute ──► MapStateNavi
     │
     └─► MapStateSearchPage ──► (回调) ──► MapStatePoi
```

---

## 9. WebSocket 通信流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     WebSocket 通信流程                           │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │  建立连接    │ new WebSocket(wsBaseUrl)
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  连接配置                                                │
    │  wsBaseUrl = "wss://map.daxicn.com/ws/loc"              │
    │  参数：token, bdid, userId, platform, ...               │
    └──────────────────────────────────────────────────────────┘
           │
           ▼
    ┌──────────────┐
    │  连接成功    │ onopen
    └──────┬───────┘
           │
           ├─► 接收消息 ──────────────────┐
           │                              │
           ▼                              │
    ┌─────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────────────────────────┐
│  消息处理                                                │
│  window.locWebSocketOnGetEvent(obj)                      │
└──────────────────────────────────────────────────────────┘
           │
           ├─► method: showExhibit       ──► 显示景点
           ├─► method: showAreaInTip     ──► 区域提示
           ├─► method: audioStatus       ──► 音频状态
           ├─► method: paySuccessEvent   ──► 支付成功
           └─► method: ...               ──► ...
           │
           ▼
    ┌──────────────┐
    │  发送消息    │ locWebSocketPostMessage(data)
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────────────────────────────────────────┐
    │  消息格式                                                │
    │  {                                                       │
    │    type: "postEventToMiniProgram",                      │
    │    id: userId,                                           │
    │    methodToMiniProgram: "method=xxx&bdid=xxx&token=xxx",│
    │    roleType: "receiver"                                  │
    │  }                                                       │
    └──────────────────────────────────────────────────────────┘
```

---

## 10. 数据流向总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据流向总览                              │
└─────────────────────────────────────────────────────────────────┘

                    ┌──────────────────┐
                    │   用户交互层     │
                    │  (UI Components) │
                    └────────┬─────────┘
                             │ 事件/命令
                             ▼
                    ┌──────────────────┐
                    │   命令总线       │
                    │   (CommandBus)   │
                    └────────┬─────────┘
                             │ 分发
                             ▼
                    ┌──────────────────┐
                    │   状态管理器     │
                    │  (StateManager)  │
                    └────────┬─────────┘
                             │ 状态变更
                             ▼
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  地图服务    │    │  API 服务     │    │  数据服务    │
│  (MapSDK)    │    │  (HTTP/WS)   │    │  (Cache)     │
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │                   │                   │
       │ POI/路线/导航数据  │ 配置/用户/业务数据  │ 缓存数据
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                           ▼
                    ┌──────────────────┐
                    │   数据模型       │
                    │  (Domain Models) │
                    └────────┬─────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │   UI 渲染        │
                    │  (React/Vue)     │
                    └──────────────────┘
```

---

**说明**: 以上流程图使用 ASCII 艺术形式展示，迁移到新版时建议使用 Mermaid 或 PlantUML 等工具重新绘制。
